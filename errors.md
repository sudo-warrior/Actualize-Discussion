
> rest-express@1.0.0 start
> NODE_ENV=production node dist/index.cjs

[static] Looking for static files at: /app/public
[static] Exists: false
/app/dist/index.cjs:272
    `})}function vC(t){return(0,Ou.createHash)("sha256").update(t).digest("hex")}async function Fa(t,e,r){let n=t.headers.authorization||t.headers["x-api-key"],i;if(typeof n=="string"&&(i=n.startsWith("Bearer ")?n.slice(7):n),!i)return e.status(401).json({error:"Missing API key. Include it as Authorization: Bearer <key> or X-API-Key header."});let s=vC(i),a=await D.findApiKeyByHash(s);if(!a)return e.status(401).json({error:"Invalid or revoked API key."});let o=100,u=new Date,c=new Date(a.lastResetDate),l=(u.getTime()-c.getTime())/(1e3*60*60),p=a.requestCount;if(l>=24&&(p=0),p>=o){let d=Math.ceil(24-l);return e.status(429).json({error:"Rate limit exceeded. You have reached the daily limit of 100 requests.",limit:o,remaining:0,resetIn:`${d} hours`})}await D.incrementApiKeyUsage(a.id),e.setHeader("X-RateLimit-Limit",o.toString()),e.setHeader("X-RateLimit-Remaining",(o-p-1).toString()),e.setHeader("X-RateLimit-Reset",new Date(c.getTime()+1440*60*1e3).toISOString()),t.apiUserId=a.userId,r()}async function xC(t,e){return ag(e,J),e.post("/api/incidents/analyze",J,async(r,n)=>{try{let i=Qm.safeParse(r.body);if(!i.success)return n.status(400).json({message:i.error.errors[0].message});let s=r.user.id;if(!s)return n.status(401).json({message:"Unauthorized"});let{logs:a}=i.data,o=await rg(a),u=await D.createIncident({title:o.title,severity:o.severity,status:"resolved",confidence:o.confidence,rawLogs:a,rootCause:o.rootCause,fix:o.fix,evidence:o.evidence,nextSteps:o.nextSteps,userId:s});if(o.severity==="critical"){let c=await D.getNotificationPreferences(s);c?.criticalAlerts&&c.email&&vE(c.email,{id:u.id,title:u.title,severity:u.severity,rootCause:u.rootCause})}return n.status(201).json(u)}catch(i){return console.error("Analysis error:",i),n.status(500).json({message:"Analysis failed. Please try again."})}}),e.get("/api/incidents",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getIncidentsByUser(i);return n.json(s)}),e.get("/api/incidents/:id",J,async(r,n)=>{let i=await D.getIncident(r.params.id);if(!i)return n.status(404).json({message:"Incident not found"});let s=r.user.id;return i.userId!==s?n.status(403).json({message:"Forbidden"}):n.json(i)}),e.patch("/api/incidents/:id/status",J,async(r,n)=>{let{status:i}=r.body;if(!["analyzing","resolved","critical"].includes(i))return n.status(400).json({message:"Invalid status"});let s=r.user.id,a=await D.getIncident(r.params.id);if(!a)return n.status(404).json({message:"Incident not found"});if(a.userId!==s)return n.status(403).json({message:"Forbidden"});if(i==="resolved"&&a.nextSteps.length>0){let u=Array.from({length:a.nextSteps.length},(c,l)=>l);await D.completeAllSteps(r.params.id,u)}let o=await D.updateIncidentStatus(r.params.id,i);if(i==="resolved"&&o){let u=await D.getNotificationPreferences(s);u?.resolvedAlerts&&u.email&&xE(u.email,{id:o.id,title:o.title,severity:o.severity})}return n.json(o)}),e.patch("/api/incidents/:id/steps/:stepIndex",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getIncident(r.params.id);if(!s)return n.status(404).json({message:"Incident not found"});if(s.userId!==i)return n.status(403).json({message:"Forbidden"});let a=parseInt(r.params.stepIndex,10);if(isNaN(a)||a<0||a>=s.nextSteps.length)return n.status(400).json({message:"Invalid step index"});let o=await D.toggleStepCompletion(r.params.id,a);return n.json(o)}),e.post("/api/incidents/:id/steps/:stepIndex/guidance",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getIncident(r.params.id);if(!s)return n.status(404).json({message:"Incident not found"});if(s.userId!==i)return n.status(403).json({message:"Forbidden"});let a=parseInt(r.params.stepIndex,10);if(isNaN(a)||a<0||a>=s.nextSteps.length)return n.status(400).json({message:"Invalid step index"});if(s.stepGuidance?.[a])return n.json({guidance:s.stepGuidance[a],cached:!0});try{let o=await lE(s.nextSteps[a],{rootCause:s.rootCause,fix:s.fix,rawLogs:s.rawLogs.slice(0,2e3)});return await D.saveStepGuidance(r.params.id,a,o),n.json({guidance:o,cached:!1})}catch(o){return console.error("Guidance error:",o),n.status(500).json({message:"Failed to generate guidance."})}}),e.delete("/api/incidents/:id",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getIncident(r.params.id);return s?s.userId!==i?n.status(403).json({message:"Forbidden"}):(await D.deleteIncident(r.params.id),n.json({success:!0})):n.status(404).json({message:"Incident not found"})}),e.get("/api/incidents/stats/summary",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getIncidentsByUser(i),a=s.length,o=s.filter(h=>h.severity==="critical").length,u=s.filter(h=>h.severity==="high").length,c=s.filter(h=>h.severity==="medium").length,l=s.filter(h=>h.severity==="low").length,p=a>0?Math.round(s.reduce((h,y)=>h+y.confidence,0)/a):0,d=s.filter(h=>{let y=new Date(h.createdAt);return Date.now()-y.getTime()<1440*60*1e3}),f={};for(let h=0;h<24;h+=4){let y=`${h.toString().padStart(2,"0")}:00`;f[y]={incidents:0,resolved:0}}for(let h of d){let y=new Date(h.createdAt).getHours(),T=`${(Math.floor(y/4)*4).toString().padStart(2,"0")}:00`;f[T]&&(f[T].incidents++,h.status==="resolved"&&f[T].resolved++)}let m=Object.entries(f).map(([h,y])=>({time:h,incidents:y.incidents,auto_resolved:y.resolved}));return n.json({total:a,critical:o,high:u,medium:c,low:l,avgConfidence:p,volumeData:m,recentIncidents:s.slice(0,10)})}),e.post("/api/keys",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let{name:s}=r.body;if(!s||typeof s!="string"||s.trim().length===0)return n.status(400).json({message:"API key name is required."});let a=`ic_${(0,Ou.randomBytes)(32).toString("hex")}`,o=vC(a),u=a.slice(0,10),c=await D.createApiKey({userId:i,name:s.trim(),keyHash:o,keyPrefix:u,revoked:!1});return n.status(201).json({id:c.id,name:c.name,key:a,keyPrefix:c.keyPrefix,createdAt:c.createdAt})}),e.get("/api/keys",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getApiKeysByUser(i);return n.json(s.map(a=>({id:a.id,name:a.name,keyPrefix:a.keyPrefix,revoked:a.revoked,requestCount:a.requestCount,lastResetDate:a.lastResetDate,lastUsedAt:a.lastUsedAt,createdAt:a.createdAt})))}),e.delete("/api/keys/:id",J,async(r,n)=>{let i=r.user.id;return i?await D.revokeApiKey(i,r.params.id)?n.json({success:!0}):n.status(404).json({message:"API key not found."}):n.status(401).json({message:"Unauthorized"})}),e.patch("/api/user/profile",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let{username:s,firstName:a,lastName:o,phone:u,dob:c}=r.body;try{let{supabase:l}=await Promise.resolve().then(()=>(ig(),dE)),{data:p,error:d}=await l.auth.admin.updateUserById(i,{user_metadata:{username:s,firstName:a,lastName:o,phone:u,dob:c}});if(d)throw d;return n.json({success:!0,user:p.user})}catch(l){return console.error("Profile update error:",l),n.status(500).json({message:"Failed to update profile"})}}),e.post("/api/templates",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let{name:s,description:a,category:o,sampleLogs:u}=r.body;if(!s||!o||!u)return n.status(400).json({message:"Missing required fields"});let c=await D.createTemplate({userId:i,name:s,description:a,category:o,sampleLogs:u});return n.status(201).json(c)}),e.get("/api/templates",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getTemplatesByUser(i);return n.json(s)}),e.delete("/api/templates/:id",J,async(r,n)=>{let i=r.user.id;return i?await D.deleteTemplate(r.params.id,i)?n.json({success:!0}):n.status(404).json({message:"Template not found"}):n.status(401).json({message:"Unauthorized"})}),e.post("/api/tags",J,async(r,n)=>{let{name:i,color:s}=r.body;if(!i)return n.status(400).json({message:"Tag name required"});let a=await D.createTag({name:i,color:s||"#3b82f6"});return n.status(201).json(a)}),e.get("/api/tags",J,async(r,n)=>{let i=await D.getAllTags();return n.json(i)}),e.post("/api/incidents/:id/tags",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getIncident(r.params.id);if(!s||s.userId!==i)return n.status(404).json({message:"Incident not found"});let{tagId:a}=r.body;return a?(await D.addTagToIncident(r.params.id,a),n.json({success:!0})):n.status(400).json({message:"Tag ID required"})}),e.delete("/api/incidents/:id/tags/:tagId",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getIncident(r.params.id);return!s||s.userId!==i?n.status(404).json({message:"Incident not found"}):(await D.removeTagFromIncident(r.params.id,r.params.tagId),n.json({success:!0}))}),e.get("/api/incidents/:id/tags",J,async(r,n)=>{let i=await D.getIncidentTags(r.params.id);return n.json(i)}),e.post("/api/favorites",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let{incidentId:s}=r.body;return s?(await D.addFavorite(i,s),n.json({success:!0})):n.status(400).json({message:"Incident ID required"})}),e.delete("/api/favorites/:incidentId",J,async(r,n)=>{let i=r.user.id;return i?(await D.removeFavorite(i,r.params.incidentId),n.json({success:!0})):n.status(401).json({message:"Unauthorized"})}),e.get("/api/favorites",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getFavorites(i);return n.json(s)}),e.post("/api/incidents/bulk/status",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let{ids:s,status:a}=r.body;if(!s||!Array.isArray(s)||s.length===0)return n.status(400).json({message:"Incident IDs required"});if(!["analyzing","resolved","critical"].includes(a))return n.status(400).json({message:"Invalid status"});let o=await D.bulkUpdateStatus(s,a,i);return n.json({success:!0,count:o})}),e.post("/api/incidents/bulk/delete",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let{ids:s}=r.body;if(!s||!Array.isArray(s)||s.length===0)return n.status(400).json({message:"Incident IDs required"});let a=await D.bulkDeleteIncidents(s,i);return n.json({success:!0,count:a})}),e.post("/api/incidents/bulk/tag",J,async(r,n)=>{if(!r.user.id)return n.status(401).json({message:"Unauthorized"});let{ids:s,tagId:a}=r.body;return!s||!Array.isArray(s)||s.length===0?n.status(400).json({message:"Incident IDs required"}):a?(await D.bulkTagIncidents(s,a),n.json({success:!0})):n.status(400).json({message:"Tag ID required"})}),e.get("/api/incidents/count/unresolved",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getUnresolvedCount(i);return n.json({count:s})}),e.get("/api/incidents/:id/export/pdf",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getIncident(r.params.id);if(!s||s.userId!==i)return n.status(404).json({message:"Incident not found"});try{let a=await bt.getConversationsByIncident(r.params.id),o=await Promise.all(a.map(async p=>({...p,messages:await bt.getMessagesByConversation(p.id)}))),{generateIncidentPDF:u}=await Promise.resolve().then(()=>(oy(),ay)),c=r.query.limit?parseInt(r.query.limit):5,l=await u(s,o,{limitMessages:c});return n.setHeader("Content-Type","application/pdf"),n.setHeader("Content-Disposition",`attachment; filename="incident-${s.id}.pdf"`),n.setHeader("Content-Length",l.length),n.send(l)}catch(a){console.error("PDF generation error:",a);let o=a.message.includes("not configured")?"PDF Export is not configured on the server.":"Failed to generate PDF report.";return n.status(500).json({message:o})}}),e.post("/api/incidents/export/bulk",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let{ids:s}=r.body;if(!s||!Array.isArray(s)||s.length===0)return n.status(400).json({message:"Incident IDs required"});try{let o=(await Promise.all(s.map(l=>D.getIncident(l)))).filter(l=>l&&l.userId===i);if(o.length===0)return n.status(404).json({message:"No valid incidents found"});let{mergeIncidentPDFs:u}=await Promise.resolve().then(()=>(oy(),ay)),c=await u(o);return n.setHeader("Content-Type","application/pdf"),n.setHeader("Content-Disposition",`attachment; filename="incidents-report-${Date.now()}.pdf"`),n.setHeader("Content-Length",c.length),n.send(c)}catch(a){console.error("Bulk PDF error:",a);let o=a.message.includes("not configured")?"PDF Export is not configured on the server.":"Failed to generate bulk PDF report.";return n.status(500).json({message:o})}}),e.post("/api/v1/incidents/analyze",Fa,async(r,n)=>{try{let i=Qm.safeParse(r.body);if(!i.success)return n.status(400).json({error:i.error.errors[0].message});let{logs:s}=i.data,a=await rg(s),o=await D.createIncident({title:a.title,severity:a.severity,status:"resolved",confidence:a.confidence,rawLogs:s,rootCause:a.rootCause,fix:a.fix,evidence:a.evidence,nextSteps:a.nextSteps,userId:r.apiUserId});return n.status(201).json({success:!0,data:o})}catch(i){return console.error("API v1 analysis error:",i),n.status(500).json({error:"Analysis failed. Please try again."})}}),e.get("/api/v1/incidents",Fa,async(r,n)=>{let i=await D.getIncidentsByUser(r.apiUserId);return n.json({success:!0,data:i,total:i.length})}),e.get("/api/v1/incidents/:id",Fa,async(r,n)=>{let i=await D.getIncident(r.params.id);return i?i.userId!==r.apiUserId?n.status(403).json({error:"Forbidden."}):n.json({success:!0,data:i}):n.status(404).json({error:"Incident not found."})}),e.patch("/api/v1/incidents/:id/status",Fa,async(r,n)=>{let{status:i}=r.body;if(!["analyzing","resolved","critical"].includes(i))return n.status(400).json({error:"Invalid status. Must be: analyzing, resolved, or critical."});let s=await D.getIncident(r.params.id);if(!s)return n.status(404).json({error:"Incident not found."});if(s.userId!==r.apiUserId)return n.status(403).json({error:"Forbidden."});let a=await D.updateIncidentStatus(r.params.id,i);return n.json({success:!0,data:a})}),e.delete("/api/v1/incidents/:id",Fa,async(r,n)=>{let i=await D.getIncident(r.params.id);return i?i.userId!==r.apiUserId?n.status(403).json({error:"Forbidden."}):(await D.deleteIncident(r.params.id),n.json({success:!0,message:"Incident deleted successfully"})):n.status(404).json({error:"Incident not found."})}),e.post("/api/incidents/:id/comments",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getIncident(r.params.id);if(!s||s.userId!==i)return n.status(404).json({message:"Incident not found"});let{content:a}=r.body;if(!a||typeof a!="string"||a.trim().length===0)return n.status(400).json({message:"Comment content required"});let o=await D.createComment({incidentId:r.params.id,userId:i,content:a.trim()});return await D.logActivity({incidentId:r.params.id,userId:i,action:"comment_added",details:"Added a comment"}),n.status(201).json(o)}),e.get("/api/incidents/:id/comments",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getIncident(r.params.id);if(!s||s.userId!==i)return n.status(404).json({message:"Incident not found"});let a=await D.getCommentsByIncident(r.params.id);return n.json(a)}),e.patch("/api/comments/:id",J,async(r,n)=>{if(!r.user.id)return n.status(401).json({message:"Unauthorized"});let{content:s}=r.body;if(!s||typeof s!="string"||s.trim().length===0)return n.status(400).json({message:"Comment content required"});let a=await D.updateComment(r.params.id,s.trim());return a?n.json(a):n.status(404).json({message:"Comment not found"})}),e.delete("/api/comments/:id",J,async(r,n)=>{let i=r.user.id;return i?await D.deleteComment(r.params.id,i)?n.json({success:!0}):n.status(404).json({message:"Comment not found"}):n.status(401).json({message:"Unauthorized"})}),e.get("/api/incidents/:id/activity",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getIncident(r.params.id);if(!s||s.userId!==i)return n.status(404).json({message:"Incident not found"});let a=await D.getActivityByIncident(r.params.id);return n.json(a)}),e.get("/api/user/role",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getUserRole(i);return n.json(s||{userId:i,role:"operator"})}),e.patch("/api/user/role",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let{role:s}=r.body;if(!["admin","operator","viewer"].includes(s))return n.status(400).json({message:"Invalid role"});let a=await D.setUserRole(i,s);return n.json(a)}),e.get("/api/user/notifications",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getNotificationPreferences(i);return n.json(s||{userId:i,email:"",criticalAlerts:!0,resolvedAlerts:!1,digestFrequency:"none"})}),e.post("/api/user/notifications",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let{email:s,criticalAlerts:a,resolvedAlerts:o,digestFrequency:u}=r.body;if(!s)return n.status(400).json({message:"Email is required"});let c=await D.setNotificationPreferences({userId:i,email:s,criticalAlerts:a??!0,resolvedAlerts:o??!1,digestFrequency:u??"none"});return n.json(c)}),e.post("/api/incidents/:id/assign",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getIncident(r.params.id);if(!s||s.userId!==i)return n.status(404).json({message:"Incident not found"});let{assignedTo:a}=r.body;return!a||typeof a!="string"?n.status(400).json({message:"assignedTo user ID required"}):(await D.assignIncident({incidentId:r.params.id,assignedTo:a,assignedBy:i}),await D.logActivity({incidentId:r.params.id,userId:i,action:"assigned",details:`Assigned to user ${a}`}),n.json({success:!0}))}),e.get("/api/incidents/:id/assign",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getIncident(r.params.id);if(!s||s.userId!==i)return n.status(404).json({message:"Incident not found"});let a=await D.getIncidentAssignment(r.params.id);return n.json(a||null)}),e.delete("/api/incidents/:id/assign",J,async(r,n)=>{let i=r.user.id;if(!i)return n.status(401).json({message:"Unauthorized"});let s=await D.getIncident(r.params.id);return!s||s.userId!==i?n.status(404).json({message:"Incident not found"}):(await D.removeIncidentAssignment(r.params.id),n.json({success:!0}))}),t}var bC=Le(Vp(),1),cy=Le(require("fs"),1),uy=Le(require("path"),1);function wC(t){let e=uy.default.resolve(__dirname,"../public");if(console.log(`[static] Looking for static files at: ${e}`),console.log(`[static] Exists: ${cy.default.existsSync(e)}`),!cy.default.existsSync(e))throw new Error(`Could not find the build directory: ${e}, make sure to build the client first`);t.use(bC.default.static(e)),t.use("/{*path}",(r,n)=>{n.sendFile(uy.default.resolve(e,"index.html"))})}var _C=require("http"),ai=(0,Ru.default)(),SC=(0,_C.createServer)(ai);ai.use(Ru.default.json({verify:(t,e,r)=>{t.rawBody=r}}));ai.use(Ru.default.urlencoded({extended:!1}));function ly(t,e="express"){let r=new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0});console.log(`${r} [${e}] ${t}`)}ai.use((t,e,r)=>{let n=Date.now(),i=t.path,s,a=e.json;e.json=function(o,...u){return s=o,a.apply(e,[o,...u])},e.on("finish",()=>{let o=Date.now()-n;if(i.startsWith("/api")){let u=`${t.method} ${i} ${e.statusCode} in ${o}ms`;if(s){let c=JSON.stringify(s);c.length>500&&(c=c.substring(0,200)+"... (truncated)"),u+=` :: ${c}`}ly(u)}}),r()});(async()=>{await xC(SC,ai),ai.use((e,r,n,i)=>{let s=e.status||e.statusCode||500,a=e.message||"Internal Server Error";return console.error("Internal Server Error:",e),n.headersSent?i(e):n.status(s).json({message:a})}),wC(ai);let t=parseInt(process.env.PORT||"5000",10);SC.listen({port:t,host:"0.0.0.0",reusePort:!0},()=>{ly(`serving on port ${t}`)})})();0&&(module.exports={log});
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            

Error: Could not find the build directory: /app/public, make sure to build the client first
    at wC (/app/dist/index.cjs:272:18914)
    at /app/dist/index.cjs:272:19999

Node.js v20.20.0
